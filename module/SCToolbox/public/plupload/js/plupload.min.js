/**
 * Plupload - multi-runtime File Uploader
 * v2.0a
 *
 * Copyright 2012, Moxiecode Systems AB
 * Released under GPL License.
 *
 * License: http://www.plupload.com/license
 * Contributing: http://www.plupload.com/contributing
 *
 * Date: 2012-11-30
 */
;(function(e,t,n){var r=e.setTimeout,s={VERSION:"2.0a",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:t.mimes,ua:t.ua,typeOf:t.typeOf,extend:t.extend,guid:t.guid,each:t.each,getPos:t.getPos,getSize:t.getSize,xmlEncode:t.xmlEncode,toArray:t.toArray,inArray:t.inArray,addI18n:t.addI18n,translate:t.translate,isEmptyObj:t.isEmptyObj,hasClass:t.hasClass,addClass:t.addClass,removeClass:t.removeClass,getStyle:t.getStyle,addEvent:t.addEvent,removeEvent:t.removeEvent,removeAllEvents:t.removeAllEvents,cleanName:function(e){var t,n;n=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(t=0;t<n.length;t+=2)e=e.replace(n[t],n[t+1]);return e=e.replace(/\s+/g,"_"),e=e.replace(/[^a-z0-9_\-\.]+/gi,""),e},buildUrl:function(e,t){var n="";return s.each(t,function(e,t){n+=(n?"&":"")+encodeURIComponent(t)+"="+encodeURIComponent(e)}),n&&(e+=(e.indexOf("?")>0?"&":"?")+n),e},formatSize:function(e){return e===n||/\D/.test(e)?s.translate("N/A"):e>1073741824?Math.round(e/1073741824,1)+" GB":e>1048576?Math.round(e/1048576,1)+" MB":e>1024?Math.round(e/1024,1)+" KB":e+" b"},parseSize:t.parseSizeStr};s.Uploader=function(e){function y(){var e,t=0,n;if(this.state==s.STARTED){for(n=0;n<u.length;n++)!e&&u[n].status==s.QUEUED?(e=u[n],e.status=s.UPLOADING,this.trigger("BeforeUpload",e)&&this.trigger("UploadFile",e)):t++;t==u.length&&(this.stop(),this.trigger("UploadComplete",u))}}function b(e){e.percent=e.size>0?Math.ceil(e.loaded/e.size*100):100,w()}function w(){var e,t;p.reset();for(e=0;e<u.length;e++)t=u[e],t.size!==n?(p.size+=t.origSize,p.loaded+=t.loaded*t.origSize/t.size):p.size=n,t.status==s.DONE?p.uploaded++:t.status==s.FAILED?p.failed++:p.queued++;p.size===n?p.percent=u.length>0?Math.ceil(p.uploaded/u.length*100):0:(p.bytesPerSec=Math.ceil(p.loaded/((+(new Date)-h||1)/1e3)),p.percent=p.size>0?Math.ceil(p.loaded/p.size*100):0)}function E(e){var t,n=[];for(t=0;t<e.length;t++)n.push(new s.File(e[t]));n.length&&this.trigger("FilesAdded",n)}function S(){var n=this,r=0;t.inSeries([function(i){if(e.browse_button)try{v=new t.FileInput({accept:e.filters,runtime_order:e.runtimes,name:e.file_data_name,multiple:e.multi_selection,container:e.container,browse_button:e.browse_button,required_caps:l,swf_url:e.flash_swf_url,xap_url:e.silverlight_xap_url}),v.onready=function(){var e=t.Runtime.getInfo(this.ruid);t.extend(n.features,{chunks:e.can("stream_upload"),multipart:e.can("send_multipart"),multi_selection:e.can("select_multiple")}),r++,i()},v.onerror=function(){i()},v.onchange=function(){E.call(n,this.files)},v.bind("mouseenter mouseleave mousedown mouseup",function(n){if(!d){var r=t(e.browse_button);r&&(e.browse_button_hover&&("mouseenter"===n.type?t.addClass(r,e.browse_button_hover):"mouseleave"===n.type&&t.removeClass(r,e.browse_button_hover)),e.browse_button_active&&("mousedown"===n.type?t.addClass(r,e.browse_button_active):"mouseup"===n.type&&t.removeClass(r,e.browse_button_active)),r=null)}}),v.init()}catch(s){i()}else i()},function(i){if(e.drop_element)try{m=new t.FileDrop({drop_zone:e.drop_element,accept:e.filters,runtime_order:e.runtimes,required_caps:l,swf_url:e.flash_swf_url,xap_url:e.silverlight_xap_url}),m.onerror=function(){i()},m.onready=function(){var e=t.Runtime.getInfo(this.ruid);n.features.dragdrop=e.can("drag_and_drop"),r++,i()},m.ondrop=function(){E.call(n,this.files)},m.init()}catch(s){i()}else i()}],function(t){r?(n.trigger("PostInit"),typeof e.init=="function"?e.init(n):s.each(e.init,function(e,t){n.bind(t,e)})):n.trigger("Error",{code:s.INIT_ERROR,message:s.translate("Init error.")})})}function x(e,n){if(e.ruid){var r=t.Runtime.getInfo(e.ruid);if(r)return r.can(n)}return!1}function T(e,n,r){var i=new t.Image;try{i.onload=function(){i.resize(n.width,n.height)},i.onresize=function(){r(i.getAsBlob(e.type,n.quality))},i.onerror=function(){r(e)},i.load(e)}catch(s){r(e)}}var u=[],a={},f=[],l={},c={},h,p,d=!1,v,m,g;p=new s.QueueProgress,e=s.extend({chunk_size:0,multipart:!0,multi_selection:!0,file_data_name:"file",filters:[],url_stream:!1},e),c={chunks:"slice_blob",resize:"send_binary_string",jpgresize:"send_binary_string",pngresize:"send_binary_string",multipart:"send_multipart",progress:"report_upload_progress",multi_selection:"select_multiple",canSendBinary:"send_binary"},typeof e.required_features=="string"&&(f=e.required_features.split(/\s*,\s*/)),f.length&&s.each(f,function(e){c[e]?l[c[e]]=!0:l[e]=!0}),s.extend(this,{id:s.guid(),state:s.STOPPED,features:{},files:u,settings:e,total:p,init:function(){var a=this;e.chunk_size=s.parseSize(e.chunk_size),e.max_file_size=s.parseSize(e.max_file_size),e.drop_element=t(e.drop_element),typeof e.preinit=="function"?e.preinit(a):s.each(e.preinit,function(e,t){a.bind(t,e)}),a.bind("FilesAdded",function(t,i){var o,f,l=0,c,h=e.filters;h&&h.length&&(c=[],s.each(h,function(e){s.each(e.extensions.split(/,/),function(e){/^\s*\*\s*$/.test(e)?c.push("\\.*"):c.push("\\."+e.replace(new RegExp("["+"/^$.*+?|()[]{}\\".replace(/./g,"\\$&")+"]","g"),"\\$&"))})}),c=new RegExp(c.join("|")+"$","i"));for(o=0;o<i.length;o++){f=i[o],f.loaded=0,f.percent=0,f.status=s.QUEUED;if(c&&!c.test(f.name)){t.trigger("Error",{code:s.FILE_EXTENSION_ERROR,message:s.translate("File extension error."),file:f});continue}if(f.size!==n&&f.size>e.max_file_size){t.trigger("Error",{code:s.FILE_SIZE_ERROR,message:s.translate("File size error."),file:f});continue}u.push(f),l++}if(!l)return!1;r(function(){a.trigger("QueueChanged"),a.refresh()},1)}),a.bind("CancelUpload",function(){g&&g.abort()}),e.unique_names&&a.bind("UploadFile",function(e,t){var n=t.name.match(/\.([^.]+)$/),r="part";n&&(r=n[1]),t.target_name=t.id+"."+r}),a.bind("UploadFile",function(n,r){function h(){var p,d,v,m,y,b,w,E;if(r.status==s.DONE||r.status==s.FAILED||n.state==s.STOPPED)return;y={name:r.target_name||r.name},e.chunk_size&&c.chunks&&r.size>e.chunk_size?(b=e.chunk_size,m=Math.ceil(r.size/b),w=Math.min(b,r.size-u*b),p=i.slice(u*b,u*b+w),y.chunk=u,y.chunks=m):(w=r.size,p=i),g=new t.XMLHttpRequest,g.upload&&(g.upload.onprogress=function(e){r.loaded=Math.min(r.size,a+e.loaded),n.trigger("UploadProgress",r)}),g.onload=function(){if(m){chunkArgs={chunk:u,chunks:m,response:g.responseText,status:g.status},n.trigger("ChunkUploaded",r,chunkArgs),a+=w;if(chunkArgs.cancelled){r.status=s.FAILED;return}r.loaded=Math.min(r.size,(u+1)*b)}else r.loaded=r.size;n.trigger("UploadProgress",r),p=d=null,!m||++u>=m?(r.status=s.DONE,n.trigger("FileUploaded",r,{response:g.responseText,status:g.status})):h()},g.onerror=function(){n.trigger("Error",{code:s.HTTP_ERROR,message:s.translate("HTTP Error."),file:r,status:g.status})},n.settings.multipart&&c.multipart?(y.name=r.target_name||r.name,g.open("post",f,!0),s.each(n.settings.headers,function(e,t){g.setRequestHeader(t,e)}),d=new t.FormData,s.each(s.extend(y,n.settings.multipart_params),function(e,t){d.append(t,e)}),d.append(n.settings.file_data_name,p),g.send(d,{runtime_order:n.settings.runtimes,required_caps:l,swf_url:n.settings.flash_swf_url,xap_url:n.settings.silverlight_xap_url})):(f=s.buildUrl(n.settings.url,s.extend(y,n.settings.multipart_params)),g.open("post",f,!0),g.setRequestHeader("Content-Type","application/octet-stream"),s.each(n.settings.headers,function(e,t){g.setRequestHeader(t,e)}),g.send(p,{runtime_order:n.settings.runtimes,required_caps:l,swf_url:n.settings.flash_swf_url,xap_url:n.settings.silverlight_xap_url}))}var i,u=0,a=0,f=n.settings.url,c=n.features;i=r.getSource(),!t.isEmptyObj(n.settings.resize)&&x(i,"send_binary_string")&&!!~t.inArray(i.type,["image/jpeg","image/png"])?T.call(this,i,n.settings.resize,function(e){i=e,r.size=e.size,h()}):h()}),a.bind("UploadProgress",function(e,t){b(t)}),a.bind("StateChanged",function(e){if(e.state==s.STARTED)h=+(new Date);else if(e.state==s.STOPPED)for(i=e.files.length-1;i>=0;i--)e.files[i].status==s.UPLOADING&&(e.files[i].status=s.QUEUED,w())}),a.bind("QueueChanged",w),a.bind("Error",function(e,t){t.file&&(t.file.status=s.FAILED,w(),e.state==s.STARTED&&r(function(){y.call(a)},1))}),a.bind("FileUploaded",function(e,t){t.status=s.DONE,t.loaded=t.size,b(t),r(function(){y.call(a)},1)}),a.trigger("Init",{runtime:"Generic"}),S.call(this)},refresh:function(){v.trigger("Refresh"),this.trigger("Refresh")},start:function(){this.state!=s.STARTED&&(this.state=s.STARTED,this.trigger("StateChanged"),y.call(this))},stop:function(){this.state!=s.STOPPED&&(this.state=s.STOPPED,this.trigger("CancelUpload"),this.trigger("StateChanged"))},disableBrowse:function(){d=arguments[0]!==n?arguments[0]:!0,v&&v.disable(d),this.trigger("DisableBrowse",d)},getFile:function(e){var t;for(t=u.length-1;t>=0;t--)if(u[t].id===e)return u[t]},removeFile:function(e){var t;for(t=u.length-1;t>=0;t--)if(u[t].id===e.id)return this.splice(t,1)[0]},splice:function(e,t){var r;return r=u.splice(e===n?0:e,t===n?u.length:t),this.trigger("FilesRemoved",r),this.trigger("QueueChanged"),r},trigger:function(e){var t=a[e.toLowerCase()],n,r;if(t){r=Array.prototype.slice.call(arguments),r[0]=this;for(n=0;n<t.length;n++)if(t[n].func.apply(t[n].scope,r)===!1)return!1}return!0},hasEventListener:function(e){return!!a[e.toLowerCase()]},bind:function(e,t,n){var r;e=e.toLowerCase(),r=a[e]||[],r.push({func:t,scope:n||this}),a[e]=r},unbind:function(e){e=e.toLowerCase();var t=a[e],r,i=arguments[1];if(t){if(i!==n){for(r=t.length-1;r>=0;r--)if(t[r].func===i){t.splice(r,1);break}}else t=[];t.length||delete a[e]}},unbindAll:function(){var e=this;s.each(a,function(t,n){e.unbind(n)})},destroy:function(){this.stop(),this.trigger("Destroy"),this.unbindAll()}})},s.File=function(){function t(t){s.extend(this,{id:s.guid(),name:t.name||t.fileName,size:t.size||t.fileSize,origSize:t.size||t.fileSize,loaded:0,percent:0,status:0,getSource:function(){return e[this.id]?e[this.id]:null}}),e[this.id]=t}var e={};return t}(),s.QueueProgress=function(){var e=this;e.size=0,e.loaded=0,e.uploaded=0,e.failed=0,e.queued=0,e.percent=0,e.bytesPerSec=0,e.reset=function(){e.size=e.loaded=e.uploaded=e.failed=e.queued=e.percent=e.bytesPerSec=0}},e.plupload=s})(window,mOxie);